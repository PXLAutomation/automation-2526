#
# Vagrantfile to create PXL Labs (libvirt + AlmaLinux)
#

Vagrant.configure("2") do |config|

  # ----- Base Box (hard pinned) -----
  config.vm.box = "generic/alma9"
  config.vm.box_version = "4.3.12"

  MEMORY    = 2048
  CPUS      = 2
  DISK_SIZE = "40G"

  # Disable default /vagrant sync folder
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # SSH config - reuse insecure key
  config.ssh.forward_agent = true
  config.ssh.insert_key = false
  config.ssh.private_key_path = "~/.vagrant.d/insecure_private_key"

  # --------------------------------
  # Libvirt Provider Configuration
  # --------------------------------
  config.vm.provider :libvirt do |lv|
    lv.memory = MEMORY
    lv.cpus   = CPUS
    lv.driver = "kvm"

    # Explicit qcow2 disk size tuning
    lv.storage :file,
      size: DISK_SIZE,
      type: "qcow2"

    lv.nested = true if lv.respond_to?(:nested=)
  end

  # --------------------------------
  # vagrant-hosts plugin integration
  # --------------------------------
  config.vagrant.plugins = "vagrant-hosts"

  if Vagrant.has_plugin?("vagrant-hosts")
    config.vm.provision :hosts do |provisioner|
      provisioner.add_localhost_hostnames = false
      provisioner.sync_hosts = true
      provisioner.autoconfigure = true
    end
  end

  # -------------------------
  # Web Server
  # -------------------------
  config.vm.define "webserver1" do |server|
    server.vm.hostname = "webserver1.pxldemo.local"

    server.vm.network "forwarded_port",
      guest: 8080, host: 8080

    server.vm.network "private_network",
      ip: "192.168.121.100"
  end

  # -------------------------
  # DB Server
  # -------------------------
  config.vm.define "dbserver1" do |server|
    server.vm.hostname = "dbserver1.pxldemo.local"

    server.vm.network "private_network",
      ip: "192.168.121.101"
  end

  config.vm.post_up_message = "PXL Lab build complete."
end